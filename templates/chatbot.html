{% extends "base.html" %}

{% block title %}CareLink - Chatbot{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4">CareLink Multilingual Chatbot</h2>

    <!-- Language Selector -->
    <div class="mb-3">
        <select id="langSelector" class="form-select" onchange="changeLanguage()">
            <option value="en" {% if lang =='en' %}selected{% endif %}>English</option>
            <option value="zh" {% if lang =='zh' %}selected{% endif %}>中文</option>
            <option value="ms" {% if lang =='ms' %}selected{% endif %}>Bahasa Melayu</option>
            <option value="ta" {% if lang =='ta' %}selected{% endif %}>தமிழ்</option>
        </select>
    </div>

    <div id="chat-box" class="border p-3 mb-3" style="height: 300px; overflow-y: auto; background: #f9f9f9;">
        <!-- Chat messages will appear here -->
    </div>

    <form id="chat-form" class="input-group">
        <input type="text" id="user-input" class="form-control" placeholder="Type your message..." autocomplete="off" required>
        <button class="btn btn-primary" type="submit">Send</button>
    </form>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const langSelector = document.getElementById('langSelector');
    const lang = "{{ lang }}";

    const welcomes = {
        en: "Hello! Ask me about seizures, steps to help, symptoms, and more.",
        zh: "你好！问我关于癫痫、救助步骤、症状等问题。",
        ms: "Hai! Tanya saya tentang sawan, langkah membantu, gejala, dan banyak lagi.",
        ta: "வணக்கம்! வலிப்புகள், உதவிப் படிகள், அறிகுறிகள் மற்றும் மேலும் என்னிடம் கேளுங்கள்."
    };

    // Append a message to chat box
    function appendMessage(sender, text) {
        const p = document.createElement("p");
        p.innerHTML = `<strong>${sender}:</strong> ${text}`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Change language without page reload
    async function changeLanguage() {
        const selectedLang = langSelector.value;
        try {
            const res = await fetch('/set_chat_lang', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lang: selectedLang })
            });
            if (!res.ok) throw new Error('Network response was not ok');

            // Clear chat and show welcome message in new language
            chatBox.innerHTML = '';
            appendMessage("Bot", welcomes[selectedLang] || welcomes.en);
        } catch (error) {
            console.error('Failed to set language:', error);
            alert('Failed to change language. Please try again.');
        }
    }

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        appendMessage("You", message);
        userInput.value = "";

        // Show typing indicator
        const typingMsg = document.createElement("p");
        typingMsg.innerHTML = "<strong>Bot:</strong> Typing...";
        chatBox.appendChild(typingMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const response = await fetch("/chatbot_api", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: message })
            });
            const data = await response.json();
            typingMsg.remove();
            appendMessage("Bot", data.reply);
        } catch (error) {
            typingMsg.remove();
            appendMessage("Bot", "Sorry, something went wrong.");
            console.error(error);
        }
    });

    // Show welcome message on load
    window.onload = () => {
        appendMessage("Bot", welcomes[lang] || welcomes.en);
    }
</script>
{% endblock %}
